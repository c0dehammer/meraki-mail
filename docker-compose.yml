version: '3'
#set outgoing IP address, if hosted on a multi ip host
#sudo iptables -t nat -I POSTROUTING -p all -s 172.31.0.0/16 -j SNAT --to -source xxx.xxx.xxx.xxx
volumes:
  modoboa-dkim:
  modoboa-vmail:
  modoboa-psql:
  modoboa-ssl:
  modoboa-letsencrypt:
  modoboa-radicale-collections:
  modoboa-radicale-rights:

services:
  modoboa:
    #image: meraki/modoboa
    build: .
    #pull_policy: never
    container_name: ${HOST}-mail-modoboa
    hostname: mail
    domainname: ${HOST}
    restart: unless-stopped
    environment:
      TZ: utc
    volumes:
      - ${HOST}-dkim:/var/lib/dkim
      - ${HOST}-vmail:/srv/vmail
      - ${HOST}-psql:/var/lib/postgresql/14/main
      - ${HOST}-ssl:/etc/ssl/
      - ${HOST}-letsencrypt:/etc/letsencrypt/
      - ${HOST}-radicale-collections:/srv/radicale/
      - ${HOST}-radicale-rights:/etc/radicale/
    #network_mode: "host"

    ports:
      - 80:80
      - 443:443
      - 25:25
      - 587:587
      - 143:143
#      - 19999:19999
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    
    networks:
      mail-net:
      
networks:
  mail-net:
    driver: bridge
    # only available in docker 2 
    # enable_ipv6: false
    ipam:
      config:
      - subnet: 172.31.0.0/16
